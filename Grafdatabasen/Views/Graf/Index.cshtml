@{
    ViewBag.Title = "Graf";
}

<div id="visual">
</div>

<div id="legend">

</div>

<div class="row">
    <p>&nbsp;</p>
    <div id="graph" style="width:100%; height:100%;">

    </div>
    <div id="details" class="col-md-4 pull-right" hidden="hidden">
        <div class="panel panel-default" style="z-index:1000">
            <div class="panel-heading">
                <h3 class="panel-title">Detaljer</h3>
            </div>
            <div class="panel-body">
                Detaljer
            </div>
        </div>

    </div>
</div>

<style>
    circle {
        stroke-width: 1.5px;
    }

    .node text {
        pointer-events: none;
        font: 10px sans-serif;
    }

    text {
        font: 10px sans-serif;
        pointer-events: none;
        /*text-anchor: middle;*/
    }

    .link {
        stroke: #999;
    }

    .legend {
    }

    #legend {
        position: absolute;
        top: 80px;
        left: 10px;
        z-index: 8;
        padding: 5px;
        background-color: white;
        opacity: 0.8;
    }

    .Assigment {
    }

    #visual {
        position:absolute;
        top:60px;
        left:10px;
    }

    #panel {
        position: absolute;
        top: 80px;
        right: 200px;
        z-index: 10;
        opacity: 0.5;
    }
</style>

<script type="text/javascript" src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>

<script type="text/javascript">
    $(document).ready(function () {

        var request = ajaxneo4j("match path= (n)-[r]-() return path");

        request.done(d3d3);

        //the helper function provided by neo4j documents
        function idIndex(a, id) {
            for (var i = 0; i < a.length; i++) {
                if (a[i].id == id) return i;
            }
            return null;
        }

        function d3d3(y) {
                // parsing the output of neo4j rest api
            var nodes = [], links = [];
            y.results[0].data.forEach(function (row) {
                row.graph.nodes.forEach(function (n) {
                    if (idIndex(nodes, n.id) == null) {


                        nodes.push({ id: n.id, label: n.labels[0], title: n.properties.Namn });

                    }
                });
                links = links.concat(row.graph.relationships.map(function (r) {
                    // the neo4j documents has an error : replace start with source and end with target
                    return { source: idIndex(nodes, r.startNode), target: idIndex(nodes, r.endNode), type: r.type };
                }));
            });
            var graph = { nodes: nodes, links: links };

            // Now do something awesome with the graph!
            var width = $(document).width(), height = $(document).height() - 100, radius = 12;

            var color = d3.scale.category20();

            var svg = d3.select("#visual").append("svg")
                    .attr("width", width).attr("height", height);

            var force = d3.layout.force()
                    .gravity(.05)
                    .charge(-500)
                    .linkDistance(20)
                    .size([width, height]);

            force
                .nodes(graph.nodes)
                .links(graph.links)
                .start();

            var link = svg.selectAll(".link")
                    .data(graph.links)
                    .enter()
                    .append("line")
                    .attr("class", "link");

            var node = svg.selectAll(".node")
                    .data(graph.nodes)
                    .enter().append("g")
                    .call(force.drag);

            node.append("circle")
                //.attr("class", function (d) { return "node " + d.label })
                //.attr("r", radius - .75)
                .attr("r", function (d) {
                    var size;
                    switch (d.label) {
                        case "Konsult":

                            radius = 20;
                            break;
                        case "Uppdrag":
                        case "Kund":
                            radius = 20;
                            break;
                        case "Beställare":
                        case "Uppgift":
                            radius = 6;
                            break;
                        default: radius = 12;
                    }
                    return radius;
                })
                .attr("fill", function (d) { return color(d.label); })
                .attr("class", function (d) { return d.label })
                .style("stroke", function (d) { return d3.rgb(color(d.label)).darker(); })
                .on("click", function (d) {
                    alert("Du klickade på: " + d.title);
                });

            node.append("text")
                .attr("dx", 2 * radius)
                .attr("dy", ".35em")
                .text(function (d) { return d.title });

            force.on("tick", function () {
                node.attr("transform", function (d) { return "translate(" + Math.max(radius, Math.min(width - radius, d.x)) + "," + Math.max(radius, Math.min(height - radius, d.y)) + ")"; });

                link.attr("x1", function (d) { return d.source.x; })
                    .attr("y1", function (d) { return d.source.y; })
                    .attr("x2", function (d) { return d.target.x; })
                    .attr("y2", function (d) { return d.target.y; });
            });
            // html title attribute Visas när man hovrar över en node. Funkar på både actor och movie.
            node.append("title")
                    .text(function (d) { return d.label; });

            var legend = d3.select("#legend").append("svg")
                .attr("class", "legend")
                .attr("width", 100)
                .attr("height", 120)
                .selectAll("g")
                .data(color.domain().slice().reverse())
                .enter().append("g")
                .attr("x", 10)
                .attr("y", 10)
                .attr("transform", function (d, i) { return "translate(0," + i * 20 + ")"; });

            legend.append("rect")
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", color);

            legend.append("text")
                .attr("x", 24)
                .attr("y", 9)
                .attr("dy", ".35em")
                .text(function (d) { return d; });
        }
    });
</script>












